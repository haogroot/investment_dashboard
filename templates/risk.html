{% extends "base.html" %}

{% block content %}
<div class="row mb-5">
    <div class="col-12">
        <h2 class="mb-4" data-i18n="risk_title">Risk Metrics & Analytics</h2>

        <!-- Correlation Matrix -->
        <div class="card p-3 mb-4">
            <h5 data-i18n="correlation_matrix">Correlation Matrix (1 Year)</h5>
            <div class="table-responsive">
                <table class="table table-bordered text-center table-sm" style="font-size: 0.9em;">
                    <thead>
                        <tr>
                            <th></th>
                            {% for row in data.correlation %}
                            <th>{{ row.ticker }}</th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in data.correlation %}
                        <tr>
                            <th class="text-start">{{ row.ticker }}</th>
                            {% for cell in row.corr_cells %}
                            {% set val = cell.val %}
                            {# Color logic: Blue for positive, Red for negative. Opacity = abs(val) #}
                            {% set bg_color = 'rgba(68, 114, 196, ' ~ val|abs ~ ')' if val >= 0 else 'rgba(231, 76, 60,
                            ' ~ val|abs ~ ')' %}
                            {# Text color: White if abs(val) > 0.5 else text-color #}
                            {% set txt_color = '#fff' if val|abs > 0.5 else 'var(--text-color)' %}

                            <td style="background-color: {{ bg_color }}; color: {{ txt_color }};"
                                title="{{ row.ticker }} vs {{ cell.target }}: {{ '%.2f'|format(val) }}">
                                {{ "%.2f"|format(val) }}
                            </td>
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <small class="text-muted" data-i18n="correlation_desc">
                * Based on daily returns over the last 252 trading days.
            </small>
        </div>

        <!-- Stress Testing -->
        <div class="card p-3">
            <h5 data-i18n="stress_test">Stress Testing (Beta Sensitivity)</h5>
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th data-i18n="scenario">Scenario</th>
                            <th class="text-end" data-i18n="market_chg">Market Move</th>
                            <th class="text-end" data-i18n="est_port_chg">Est. Portfolio Move</th>
                            <th class="text-end" data-i18n="est_pnl">Est. P&L</th>
                            <th class="text-end" data-i18n="est_nav">Est. NAV</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for res in data.stress_test %}
                        <tr>
                            <td>{{ res.scenario }}</td>
                            <td class="text-end">{{ res.market_change | pct }}</td>
                            <td class="text-end {{ 'text-green' if res.est_portfolio_change >= 0 else 'text-red' }}">
                                {{ res.est_portfolio_change | pct }}
                            </td>
                            <td
                                class="text-end privacy-sensitive {{ 'text-green' if res.est_pnl >= 0 else 'text-red' }}">
                                {{ res.est_pnl | currency }}
                            </td>
                            <td class="text-end privacy-sensitivefw-bold">{{ res.est_nav | currency }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    // Additional translations for Risk page
    const riskTranslations = {
        en: {
            risk_title: "Risk Metrics & Analytics",
            correlation_matrix: "Correlation Matrix (1 Year)",
            correlation_desc: "* Based on daily returns over the last 252 trading days.",
            stress_test: "Stress Testing (Beta Sensitivity)",
            scenario: "Scenario",
            market_chg: "Market Move",
            est_port_chg: "Est. Portfolio Move",
            est_pnl: "Est. P&L",
            est_nav: "Est. NAV",
            ticker: "Ticker"
        },
        zh: {
            risk_title: "風險指標與分析",
            correlation_matrix: "相關性矩陣 (近一年)",
            correlation_desc: "* 基於最近 252 個交易日的日報酬率計算。",
            stress_test: "壓力測試 (Beta 敏感度)",
            scenario: "情境",
            market_chg: "市場變動",
            est_port_chg: "預估組合變動",
            est_pnl: "預估損益",
            est_nav: "預估淨值",
            ticker: "代號"
        }
    };

    // Merge into base translations
    Object.assign(translations.en, riskTranslations.en);
    Object.assign(translations.zh, riskTranslations.zh);

    // Re-run update to apply new keys if page loaded
    updateLanguage();
</script>
{% endblock %}